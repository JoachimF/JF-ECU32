

<canvas id="rpmpump" style="display: block; box-sizing: border-box; height: 300px; width: 600px;"></canvas>
<div class="card">
    <table>
      <tbody>
          <tr>
              <td>Power Start</td>
              <td>RPM Start</td>
          </tr>
          <tr>
              <td id=power_start>0</td>
              <td id=rpmstart>0</td>
          </tr>
          <tr>
              <td>Power Min</td>
              <td>RPM Max</td>
          </tr>
          <tr>
              <td id=powermin>0</td>
              <td id=rpmmax>0</td>
          </tr>
      </tbody>
    </table>
</div>
<canvas id="timerpm" style="display: block; box-sizing: border-box; height: 300px; width: 600px;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.0.1/dist/chart.umd.min.js"></script>
<script>
    //window.addEventListener("load", getData);
    var maxtime = 1000 ;
	const chart1 = new Chart(document.getElementById("rpmpump"), {
		type : 'line',
		data : {
			labels : [],
			datasets : [
					{
						data : [],
						label : "RPM/Starter",
						borderColor : "#3cba9f",
						fill : false
					}]
		},
		options : {
			title : {
				display : true,
				text : 'RPM by Starter power'
			}
		}
	});
    const chart2 = new Chart(document.getElementById("timerpm"), {
		type : 'line',
		data : {
			labels : [],
			datasets : [
					{
						data : [],
						label : "RPM/Time",
						borderColor : "#3cba9f",
						fill : false
					}]
		},
		options : {
			title : {
				display : true,
				text : 'RPM in time'
			},
            scales: {
                y : {
                    type: 'linear', //RPM
                    min : 0 ,
                    max : 1000
                },
                x : {
                    type: 'linear', //Temps en ms
                    min : 0 ,
                    max : maxtime
                },
            }
		}
	});

    var max_rpm = 0 ;
    function getData() {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var myObj = JSON.parse(this.responseText);
                console.log(myObj);
                var chartdata = myObj.data;
                //console.log(chartdata);
                var labels = myObj.labels ;
                //console.log(labels);
                var end = myObj.end ;
                var i = 0 ;
                chart1.data.labels.push(labels.toFixed(1)) ;
                chart1.data.datasets.forEach((dataset) => {
                        dataset.data.push(chartdata);
                });
                var power_start = myObj.power_start ;
                var rpmmax = myObj.rpmmax ;
                var powermin = myObj.powermin ;
                var rpmstart = myObj.rpmstart ;
                document.getElementById('power_start').innerHTML = power_start.toFixed(1);
                document.getElementById('rpmstart').innerHTML = rpmstart;
                document.getElementById('powermin').innerHTML = powermin.toFixed(1);
                document.getElementById('rpmmax').innerHTML = rpmmax;
                if(end == 1 )
                {
                    clearInterval(refreshIntervalId) ;
                }
                chart1.update();

                var rpm = myObj.rpm ;
                var time = myObj.time ;
                if(rpm > max_rpm)
                {
                    max_rpm = rpm ;
                    chart2.config.options.scales.y.max = max_rpm + 1000 ;
                }
                if(time > maxtime)
                {
                    chart2.config.options.scales.x.min = time - 990 ;
                    chart2.config.options.scales.x.max = time + 10  ;
                }
                
                chart2.data.labels.push(time) ;
                chart2.data.datasets.forEach((dataset) => {
                        dataset.data.push(rpm);
                });
                chart2.update();
            }
        };
        xhr.open("GET", "/chart_starter_cal", true);
        xhr.send();
    }

    var refreshIntervalId = setInterval(getData,100) ;
</script>

